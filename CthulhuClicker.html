<!doctype html>
<html lang="us">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=640, user-scalable=no" />
	<title>Cthulhu Clicker</title>
	<link href="css/ui-lightness/jquery-ui-1.10.4.custom.css" rel="stylesheet">
	<link href="css/CthulhuClickerCSS.css" rel="stylesheet">
	<script src="js/jquery-1.10.2.js"></script>
	<script src="js/jquery-ui-1.10.4.custom.js"></script>
	<script src="js/CthulhuClickerDivs.js"></script>

</head>

<body style="background-color:black" id="thewholebody">

<div id="topBar" style="position: relative; width:600px; height:46px;">
  <button id="topMenuButton" onclick="showMenu()" style="position: absolute; top:0px; left:0px; width:40px; height:40px; padding:3px;">
  <img style="position: absolute; top:2px; left:2px; padding:0px; z-index:1" src="images/topmenu.png"></button>
  
  <div id="topMenuMessages" style="position: absolute; top:0px; left:43px; width:514px; height:40px; padding:0px; background-color:white"></div>

  <button id="topInfoButton" onclick="showInfo()" style="position: absolute; top:0px; left:560px; width:40px; height:40px; padding:3px;">
  <img style="position: absolute; top:2px; left:2px; padding:0px; z-index:1" src="images/topinfo.png"></button>
</div>

<div id="topBarList" style="position: relative; width:600px; height:74px;" hidden=true>

  <div id="topMenuList" style="color:red;" hidden=true>
    <table>
	  <tr><td style="color:blue;background-color:white" onclick="saveGame()">Save</td></tr>
	  <tr><td style="color:blue;background-color:white" onclick="if(confirm('Reset your game?'))resetGame()">Reset Game</td></tr>
	</table>
  </div>
  
  <div id="topInfoList" style="color:red; position:absolute; top:0px; left:499px;" hidden=true>
    <table>
	  <tr><td style="color:blue;background-color:white" onclick="about()">About</td></tr>
	  <tr><td style="color:blue;background-color:white" onclick="versionHistory()">Version History</td></tr>
	  <tr><td style="color:blue;background-color:white" onclick="messageLog()">Message Log</td></tr>
	</table>
  </div>
</div>

<div id="aboutInfoPage" style="width:600px" hidden=true>
  <button id="aboutInfoBack" onclick="backToGame()">Back</button>
  <div id="aboutInfoText" style="background-color:white">
    Cthulhu Clicker is an incremental game
    designed by Shawn FitzPatrick of nthird games. I plan to eventually make it a part of a larger game 
    called Idle Like a Monster where you can switch between different monster classes.<br><br>
   
    This game owes a huge debt of gratitude to HP Lovecraft and his Cthulhu Mythos and all the authors 
    and creators that expanded upon it. Inspiration for this game was drawn from Cookie Clicker, Candy Box, 
    Clicking Bad and scores of other awesome incremental games.</div>
</div>

<div id="versionHistoryInfoPage" style="width:600px" hidden=true>
  <button id="versionHistoryInfoBack" onclick="backToGame()">Back</button>
  <div id="versionHistoryInfoText" style="background-color:white">
    Version 0.5 - Converted all of the old divs with buttons in them into clickable divs and changed the text 
	to accommodate that.<br>
	Moved the text from the divs to display in the top bar and be added to the message log.<br>
	Implemented info button in the top bar with about, version history, and message log.<br>
	Made a bunch of changes to fix typos and clarify the text.<br>
	Added inline icons to represent madness and money costs and generation.<br>
	Some other bug fixes including a change to the save which might break existing saves.<br>
	<br>
	Version 0.4 - Adding in automatic and manual saving.<br>
	<br>
	Everything before this I didn't record into version numbers :D
  </div>
</div>

<div id="messageLogInfoPage" style="width:600px" hidden=true>
  <button id="messageLogInfoBack" onclick="backToGame()">Back</button>
  <div id="messageLogInfoText" style="background-color:white"></div>
</div>

<div id="madnessTabs" style="position: relative; width:600px; height:80px;">
  <button id="madnessMadnessTab" onclick="changeMadnessTab('madnessMadnessTab')" style="position: absolute; top:0px; left:0px; width:80px; height:80px; padding:3px;" hidden=true>
  <img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempmadness.png">
  <img id="madnessnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
  
  <button id="madnessMoneyTab" onclick="changeMadnessTab('madnessMoneyTab')" style="position: absolute; top:0px; left:86px; width:80px; height:80px; padding:3px;" hidden=true>
  <img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempmoney.png">
  <img id="moneynotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
  
  <button id="madnessKnowTab" onclick="changeMadnessTab('madnessKnowTab')" style="position: absolute; top:0px; left:172px; width:80px; height:80px; padding:3px;" hidden=true>
  <img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempknow.png">
  <img id="knownotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
  
  <button id="madnessMightTab" onclick="changeMadnessTab('madnessMightTab')" style="position: absolute; top:0px; left:258px; width:80px; height:80px; padding:3px;" hidden=true>
  <img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempmight.png">
  <img id="mightnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
</div>
	
<div id="outerWrapper" style="position:relative; width:500px; height:400px">
  <div id="innerWrapper" style="position:absolute; top:0px; left:0px; width:500px; height:400px;">
    <div id="madnessDisplay" style="color:white">
      <div id="madness" style="float:left">Madness: 0</div>
	  <div id="madnesschar"><img src='images/madnesschar.png' align='top'></img></div>
      <div id="madnessPerSecond" style="float:left">Madness Per Second: 0</div>
	  <div id="madnesscharpers"><img src='images/madnesschar.png' align='top'></img>/s</div>
      <div id="madnessButtonDiv"><img src="images/CthulhuShawnDrawing.png" id="madnessClickButton"></div>
	  <div id="madnessStatusDiv">The elder gods are stirring</div>
    </div>
	<div id="moneyDisplay" style="color:white" hidden=true>
      <div id="money" style="float:left">Money: 0</div>
	  <div id="moneychar"><span style="color:green">$</span></div> 
      <div id="moneyPerSecond" style="float:left">Money Per Second: 0</div>
	  <div id="moneycharpers"><span style="color:green">$</span>/s</div>
      <div id="moneyButtonDiv"><img src="images/CthulhuShawnDrawing.png" id="moneyClickButton"></div>
	  <div id="moneyStatusDiv">No account earning you no interest in </div>
    </div>
	<div id="knowDisplay" style="color:white" hidden=true>
      <div id="know">Knowledge: 0</div>
      <div id="knowPerSecond">Knowledge Per Second: 0</div>
      <div id="knowButtonDiv"><img src="images/CthulhuShawnDrawing.png" id="knowClickButton"></div>
	  <div id="knowStatusDiv">Research strength </div>
    </div>
	<div id="mightDisplay" style="color:white" hidden=true>
      <div id="might">Might: 0</div>
      <div id="mightPerSecond">Might Per Second: 0</div>
      <div id="mightButtonDiv"><img src="images/CthulhuShawnDrawing.png" id="mightClickButton"></div>
	  <div id="mightStatusDiv">Army strength </div>
    </div>
  </div>
  <canvas id="wholeScreenCanvas" style="position:absolute; top:0px; left:0px;" width="500" height="400"></canvas>
</div>

<div id="madnessStats">
  <div id="madnessMinionsOne" hidden=true>Madness Minions 1: 0</div>
  <div id="madnessMinionsTwo" hidden=true>Madness Minions 2: 0</div>
  <div id="madnessMinionsThree" hidden=true>Madness Minions 3: 0</div>
  <div id="madnessMinionsFour" hidden=true>Madness Minions 4: 0</div>
  <div id="madnessMinionsFive" hidden=true>Madness Minions 5: 0</div>
  <div id="madnessMinionsSix" hidden=true>Madness Minions 6: 0</div>
  <div id="madnessMinionsSeven" hidden=true>Madness Minions 7: 0</div>
  <div id="madnessMinionsEight" hidden=true>Madness Minions 8: 0</div>
</div>

<div id="madnessSpread">
  <div id="madnessMadnessTabs" style="position: relative; width:800px; height:80px;">
    <button id="madnessMadnessBuildingsSubTab" onclick="changeMadnessSubTab('madnessMadnessBuildingsSubTab')" style="position: absolute; top:0px; left:0px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempminions.png">
    <img id="madnessbuildingsnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMadnessUpgradesSubTab" onclick="changeMadnessSubTab('madnessMadnessUpgradesSubTab')" style="position: absolute; top:0px; left:86px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempupgrade.png">
    <img id="madnessupgradesnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMadnessBoughtUpgradesSubTab" onclick="changeMadnessSubTab('madnessMadnessBoughtUpgradesSubTab')" style="position: absolute; top:0px; left:172px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempbought.png">
    <img id="madnessboughtupgradesnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMadnessSkillsSubTab" onclick="changeMadnessSubTab('madnessMadnessSkillsSubTab')" style="position: absolute; top:0px; left:258px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempskills.png">
    <img id="madnessskillsnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
  </div>
  <div id="madnessSpreadUpgrades" hidden=true></div>
  <div id="madnessSpreadConvert" hidden=true></div>
  <div id="madnessSpreadBoughtUpgrades" hidden=true></div>
  
</div>

<div id="moneyStats">
  <div id="moneyBuildingsOne" hidden=true>Money Buildings 1: 0</div>
  <div id="moneyBuildingsTwo" hidden=true>Money Buildings 2: 0</div>
  <div id="moneyBuildingsThree" hidden=true>Money Buildings 3: 0</div>
  <div id="moneyBuildingsFour" hidden=true>Money Buildings 4: 0</div>
  <div id="moneyBuildingsFive" hidden=true>Money Buildings 5: 0</div>
  <div id="moneyBuildingsSix" hidden=true>Money Buildings 6: 0</div>
  <div id="moneyBuildingsSeven" hidden=true>Money Buildings 7: 0</div>
  <div id="moneyBuildingsEight" hidden=true>Money Buildings 8: 0</div>
</div>

<div id="madnessInvest" hidden=true>
  <div id="madnessMoneyTabs" style="position: relative; width:800px; height:80px;">
    <button id="madnessMoneyBuildingsSubTab" onclick="changeMadnessSubTab('madnessMoneyBuildingsSubTab')" style="position: absolute; top:0px; left:0px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempbuildings.png">
    <img id="moneybuildingsnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMoneyUpgradesSubTab" onclick="changeMadnessSubTab('madnessMoneyUpgradesSubTab')" style="position: absolute; top:0px; left:86px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempupgrade.png">
    <img id="moneyupgradesnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMoneyBoughtUpgradesSubTab" onclick="changeMadnessSubTab('madnessMoneyBoughtUpgradesSubTab')" style="position: absolute; top:0px; left:172px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempbought.png">
    <img id="moneyboughtupgradesnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
    <button id="madnessMoneySkillsSubTab" onclick="changeMadnessSubTab('madnessMoneySkillsSubTab')" style="position: absolute; top:0px; left:258px; width:80px; height:80px; padding:3px;" hidden=true>
	<img style="position: absolute; top:6px; left:6px; padding:0px; z-index:1" src="images/tempskills.png">
    <img id="moneyskillssnotify" style="position: absolute; top:6px; left:6px; padding:0px; z-index:-100" src="images/tempnotify.png"></button>
	
  </div>
  <div id="madnessInvestUpgrades" hidden=true></div>  
  <div id="madnessInvestBuildings" hidden=true></div>
  <div id="madnessInvestBoughtUpgrades" hidden=true></div>
</div>

<div id="knowStats">
  <div id="knowMinionsOne" hidden=true>Knowledge Minions 1: 0</div>
  <div id="knowMinionsTwo" hidden=true>Knowledge Minions 2: 0</div>
  <div id="knowMinionsThree" hidden=true>Knowledge Minions 3: 0</div>
  <div id="knowMinionsFour" hidden=true>Knowledge Minions 4: 0</div>
  <div id="knowMinionsFive" hidden=true>Knowledge Minions 5: 0</div>
  <div id="knowMinionsSix" hidden=true>Knowledge Minions 6: 0</div>
  <div id="knowMinionsSeven" hidden=true>Knowledge Minions 7: 0</div>
  <div id="knowMinionsEight" hidden=true>Knowledge Minions 8: 0</div>
</div>

<div id="madnessResearch" hidden=true>
  <div id="madnessResearchUpgrades">
    <div id="madnessKnowUpgrades" hidden=true class="divheader">UPGRADES</div>
  </div>
  
  <div id="madnessResearchBuildings">
    <div id="madnessKnowBuildings" hidden=true class="divheader">MINIONS</div>
  </div>

  <div id="madnessResearchBoughtUpgrades">
    <div id="madnessKnowBoughtUpgrades" hidden=true class="divheader">BOUGHT UPGRADES</div>
  </div>
</div>

<div id="fightStats">
  <div id="fightMinionsOne" hidden=true>Might Minions 1: 0</div>
  <div id="fightMinionsTwo" hidden=true>Might Minions 2: 0</div>
  <div id="fightMinionsThree" hidden=true>Might Minions 3: 0</div>
  <div id="fightMinionsFour" hidden=true>Might Minions 4: 0</div>
  <div id="fightMinionsFive" hidden=true>Might Minions 5: 0</div>
  <div id="fightMinionsSix" hidden=true>Might Minions 6: 0</div>
  <div id="fightMinionsSeven" hidden=true>Might Minions 7: 0</div>
  <div id="fightMinionsEight" hidden=true>Might Minions 8: 0</div>
</div>

<div id="madnessFight" hidden=true>
  <div id="madnessFightUpgrades">
    <div id="madnessMightUpgrades" hidden=true class="divheader">UPGRADES</div>
  </div>
  
  <div id="madnessFightBuildings">
    <div id="madnessMightBuildings" hidden=true class="divheader">MINIONS</div>
  </div>

  <div id="madnessFightBoughtUpgrades">
    <div id="madnessMightBoughtUpgrades" hidden=true class="divheader">BOUGHT UPGRADES</div>
  </div>
</div>

	<script>
	
	var canvas = document.getElementById('wholeScreenCanvas');
    var context = canvas.getContext('2d');
	
	var sources = {
	  zzz: "images/zzz.png",
	  wait: "images/ellipsis.png",
	  madnesschar: "images/madnesschar.png",
	};
	var images;
	
	var GameOn = true;
	var frameCounter = 1;
	var secondCounter = 1;
	var minuteCounter = 1;
	var currMadness = 0;
	var currMoney = 0;
	var currKnow = 0;
	var currMight = 0;
	
	var madnessPerClick = 1;
	var madnessPerClickBonus = 1; // FIXME: use this later to get extra madness from money or something
	var madnessPerBuildingClickMult = 0;
	var moneyPerClick = 1;
	var moneyPerClickBonus = 1;
	var moneyPerBuildingClickMult = 0;
	var knowPerClick = 1;
	var knowPerClickBonus = 1;
	var knowPerBuildingClickMult = 0;
	var mightPerClick = 1;
	var mightPerClickBonus = 1;
	var mightPerBuildingClickMult = 0;
	
	var moneyDailyInterest = 0;
	var moneyBankAccountKey = "none";
	
	var totalClicks = 0;
	var totalMadnessClicks = 0;
	var totalMadnessFromClicking = 0;
	var madnessSpent = 0; // FIXME: I'm not currently calling this at all
	var totalMoneyClicks = 0;
	var totalMoneyFromClicking = 0;
	var moneySpent = 0;
	var totalKnowClicks = 0;
	var totalKnowFromClicking = 0;
	var knowSpent = 0;
	var totalMightClicks = 0;
	var totalMightFromClicking = 0;
	var mightSpent = 0;
	var totalConvertClicks = 0;
	var convertCostReduction = 0;
	var totalMinionsConverted = 0;
	var totalMoneyBuildingsConverted = 0;
	var totalUpgrades = 0;
	
	var madnessMinions = {};
	var currMadnessPerSecond = 0;
	var madnessPerSecondBonus = 1;
	var currMoneyPerSecond = 0;
	var moneyPerSecondBonus = 1;
	var currKnowPerSecond = 0;
	var knowPerSecondBonus = 1;
	var currMightPerSecond = 0;
	var mightPerSecondBonus = 1;
	var triggeredMadnessDivs = {}; // this is the array for divs which get unlocked by a direct action (new areas)
	var unlockableMadnessDivs = {}; // these unlock whenever the right conditions are met
	var visibleMadnessDivs = {};
	var boughtMadnessDivs = {};
	
	var visibleMadnessClickButtons = [];
	var disabledMadnessClickButtons = [];
	
	var hiddenMadnessTabs = [];
	var visibleMadnessTabs = [];
	var tabsUnlocked = 0;
	var subTabsUnlocked = 0;
	
	var hiddenMadnessSubTabs = [];
	var visibleMadnessSubTabs = [];
	
	var popUpNumbers = [];
	var showClickImage = false;
	var clickImage;
	
	var currTab = "madnessMadnessTab";
	var currSubTab = "madnessMadnessBuildingsSubTab";
	
	var menuExpanded = false;
	var infoExpanded = false;
	var topBarExpanded = false;
	var topBarOffset = 74;
	
	var savedStats = [];
	var allMadnessDivSaveData = {};
	var allMadnessTabSaveData = {};
	var allMadnessSubTabSaveData = {};
	var allMadnessClickButtonSaveData = {};
	
	var topBarDisplayMessageCounter = 0;
	var messageLogMessages = [];
	
	function madnessCost(aMadnessCost) {
	  return aMadnessCost;
	}
	
	function madnessMinion(aMadnessMinion) {
	  return aMadnessMinion;
	}
	
	function madnessMinionCost(aMadnessMinionCost) {
	  return aMadnessMinionCost;
	}
	
	function madnessClickButton(aMadnessClickButton) {
	  return aMadnessClickButton;
	}
	
	function madnessTab(aMadnessTab) {
	  return aMadnessTab;
	}
	
	function madnessSubTab(aMadnessSubTab) {
	  return aMadnessSubTab;
	}
	
	function popUpNumber(aPopUpNumber) {
	  return aPopUpNumber;
	}
	
	function madnessDivSaveData(aMadnessDivSaveData) {
	  return aMadnessDivSaveData;
	}
	
	function messageLogMessage(aMessageLogMessage) {
	  var dateTime = new Date();
	  var dateTimeString = "";
	  dateTimeString+= (dateTime.getMonth() + 1) + "/";
	  dateTimeString+= (dateTime.getDate()) + "/";
	  dateTimeString+= (dateTime.getFullYear()) + " ";
	  dateTimeString+= (dateTime.getHours()) + ":";
	  dateTimeString+= (dateTime.getMinutes());
	  aMessageLogMessage.timeStamp = dateTimeString;
	  return aMessageLogMessage;
	}
	
	function loadImages(sources, callback) {
      images = {};
      var loadedImages = 0;
      var numImages = 0;
      // get num of sources
      for(var src in sources) {
        numImages++;
      }
      for(var src in sources) {
        images[src] = new Image();
        images[src].onload = function() {
          if(++loadedImages >= numImages) {
            callback();
          }
        };
        images[src].src = sources[src];
      }
    }
	
	function showMenu() {
	  document.getElementById("topMenuList").hidden = !document.getElementById("topMenuList").hidden;
	  menuExpanded = !menuExpanded;
	  
	  if (menuExpanded || infoExpanded) { // if either is open
	    document.getElementById("topBarList").hidden = false;
		topBarExpanded = true;
	  }
	  else { // if both are closed
	    document.getElementById("topBarList").hidden = true;
		topBarExpanded = false;
	  }
	}
	
	function showInfo() {
	  document.getElementById("topInfoList").hidden = !document.getElementById("topInfoList").hidden;
	  infoExpanded = !infoExpanded;
	  
	  if (menuExpanded || infoExpanded) { // if either is open
	    document.getElementById("topBarList").hidden = false;
		topBarExpanded = true;
	  }
	  else { // if both are closed
	    document.getElementById("topBarList").hidden = true;
		topBarExpanded = false;
	  }
	}
	
	function hideGameScreen() {
	  //GameOn = false;
	  document.getElementById('outerWrapper').hidden = true;
	  document.getElementById('madnessTabs').hidden = true;
	  document.getElementById('madnessSpread').hidden = true;
	  document.getElementById('madnessInvest').hidden = true;
	  document.getElementById('madnessResearch').hidden = true;
	  document.getElementById('madnessFight').hidden = true	;
	}
	
	function backToGame() {
	  document.getElementById('aboutInfoPage').hidden=true;
	  document.getElementById('versionHistoryInfoPage').hidden=true;
	  document.getElementById('messageLogInfoPage').hidden=true;
	  document.getElementById('outerWrapper').hidden = false;
	  document.getElementById('madnessTabs').hidden = false;
	  changeMadnessTab("madnessMadnessTab");
	}
	
	function about() {
	  hideGameScreen();
	  document.getElementById('aboutInfoPage').hidden=false;
	}
	
	function versionHistory() {
	  hideGameScreen();
	  document.getElementById('versionHistoryInfoPage').hidden=false;
	}
	
	function messageLog() {
	  hideGameScreen();
	  document.getElementById('messageLogInfoPage').hidden=false;
	  var messagesString = "";
	  for (var i=messageLogMessages.length-1; i>=0; i--) {
	    messagesString += (messageLogMessages[i].timeStamp + " - ");
		messagesString += (messageLogMessages[i].eventstring + "<br>");
		messagesString += (messageLogMessages[i].messagestring + "<br><br>");
	  }
	  document.getElementById('messageLogInfoText').innerHTML = messagesString;
	}

	function madnessClickClick(id) {
	  visibleMadnessClickButtons[id].click();
	}
	
	function madnessClick(key) {
	  var doClick = true;
	  for (var i=0; i<visibleMadnessDivs[key].costs.length; i++) {
		if (visibleMadnessDivs[key].costs[i].type == "madness") {
		  if (currMadness < visibleMadnessDivs[key].costs[i].current)
		    doClick = false;
		  }
		else if (visibleMadnessDivs[key].costs[i].type == "money") {
		  if (currMoney < visibleMadnessDivs[key].costs[i].current)
		    doClick = false;
		}
		else if (visibleMadnessDivs[key].costs[i].type == "know") {
		  if (currKnow < visibleMadnessDivs[key].costs[i].current)
		    doClick = false;
		}
		else if (visibleMadnessDivs[key].costs[i].type == "might") {
		  if (currMight < visibleMadnessDivs[key].costs[i].current)
		    doClick = false;
		}
	  }
	  if (doClick)
	    visibleMadnessDivs[key].click();
	}
	
	function doMouseDown(event) {
	  event.preventDefault();
	  mouseX = event.pageX;
	  mouseY = event.pageY;
	  // FIXME: change these numbers when I put a real image in
	  var offset = 46;
	  if (topBarExpanded)
	    offset += topBarOffset;
	  if (mouseX >= 8 && mouseX <= 332 && mouseY >= 127 + offset && mouseY <= 451 + offset) { // click on the picture
	    if (currTab == "madnessMadnessTab") {
		  visibleMadnessClickButtons['madnessClickButton'].click(mouseX, mouseY - offset);
		  showClickImage = true;
		  clickImage = images.zzz;
		}
		else if (currTab == "madnessMoneyTab") {
		  visibleMadnessClickButtons['moneyClickButton'].click(mouseX, mouseY - offset);
		  showClickImage = true;
		  clickImage = images.wait;
		}
	  }
	}
	
	function doMouseUp(event) {
	  showClickImage = false;
	}

	function changeMadnessTab(id) {
	  currTab = id;
	  for (var key in visibleMadnessTabs) {
	    visibleMadnessTabs[key].contains.hidden = true;
		visibleMadnessTabs[key].display.hidden = true;
		visibleMadnessTabs[key].active = false;
	  }
	  for (var key2 in visibleMadnessSubTabs) {
	    visibleMadnessSubTabs[key2].contains.hidden = true;
		visibleMadnessSubTabs[key2].active = false;
	  }
	  visibleMadnessTabs[id].contains.hidden = false;
	  visibleMadnessTabs[id].display.hidden = false;
	  visibleMadnessTabs[id].active = true;
	  visibleMadnessTabs[id].notifications = 0;
	  document.getElementById(visibleMadnessTabs[id].notifyid).style.zIndex = -100;
	  visibleMadnessTabs[id].showingnotify = false;
	  
	  if (typeof(visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab]) == "object") {
	    visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab].contains.hidden = false;
	    visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab].active = true;
	    visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab].notifications = 0;
	    document.getElementById(visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab].notifyid).style.zIndex = -100;
	    visibleMadnessSubTabs[visibleMadnessTabs[id].buildingssubtab].showingnotify = false;
	  }
	}
	
	function changeMadnessSubTab(id) {
	  currSubTab = id;
	  for (var key in visibleMadnessSubTabs) {
	    visibleMadnessSubTabs[key].contains.hidden = true;
		visibleMadnessSubTabs[key].active = false;
	  }
	  visibleMadnessSubTabs[id].contains.hidden = false;
	  visibleMadnessSubTabs[id].active = true;
	  visibleMadnessSubTabs[id].notifications = 0;
	  document.getElementById(visibleMadnessSubTabs[id].notifyid).style.zIndex = -100;
	  visibleMadnessSubTabs[id].showingnotify = false;
	}
	
	function addNotifyTab(id) {
	  if (typeof(visibleMadnessTabs[id]) == "object") {
	    if (!visibleMadnessTabs[id].active)
		  visibleMadnessTabs[id].notifications++;
	  }
	  else {
	    if (!hiddenMadnessTabs[id].active)
		  hiddenMadnessTabs[id].notifications++;
	  }
	}
	
	function addNotifySubTab(id) {
	  if (typeof(visibleMadnessSubTabs[id]) == "object") {
	    if (!visibleMadnessSubTabs[id].active)
		  visibleMadnessSubTabs[id].notifications++;
	  }
	  else {
	    if (!hiddenMadnessSubTabs[id].active)
		  hiddenMadnessSubTabs[id].notifications++;
	  }
	}
	
	function displayTopBarMessage(aString) {
	  document.getElementById('topMenuMessages').innerHTML = aString;
	  // FIXME: add it to the log here if not game saved
	  topBarDisplayMessageCounter = 30;
	}
	
	function clearTopBarMessage() {
	  document.getElementById('topMenuMessages').innerHTML = "";
	}
	
	function displayAndLogMessage(anEvent, aMessage) {
	  displayTopBarMessage(aMessage);
	  messageLogMessages.push(messageLogMessage({
	    eventstring: anEvent,
		messagestring: aMessage,
	  }));
	}
	
	function displayUpdatedStats(key) {
	  var updatedStatsString = "";
	  var statsMin = visibleMadnessDivs[key].minion;
	  if (madnessMinions[statsMin].madnessPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].madnessPerSecond * madnessMinions[statsMin].bonus +
		"&nbsp;<img src='images/madnesschar.png' align='top'></img>" + "/s ";
	  if (madnessMinions[statsMin].moneyPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].moneyPerSecond * madnessMinions[statsMin].bonus + 
		"&nbsp;<span style='color:green'>$</span>" + "/s ";
	  if (madnessMinions[statsMin].knowPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].knowPerSecond * madnessMinions[statsMin].bonus + " k/s ";
	  if (madnessMinions[statsMin].mightPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].mightPerSecond * madnessMinions[statsMin].bonus + " f/s";
	  document.getElementById(visibleMadnessDivs[key].statsdiv).innerHTML = updatedStatsString;
	}
	
	function displayOriginalStats(key) {
	  var updatedStatsString = "";
	  var statsMin = unlockableMadnessDivs[key].minion;
	  if (madnessMinions[statsMin].madnessPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].madnessPerSecond * madnessMinions[statsMin].bonus +
		"&nbsp;<img src='images/madnesschar.png' align='top'></img>" + "/s ";
	  if (madnessMinions[statsMin].moneyPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].moneyPerSecond * madnessMinions[statsMin].bonus + 
		"&nbsp;<span style='color:green'>$</span>" + "/s ";
	  if (madnessMinions[statsMin].knowPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].knowPerSecond * madnessMinions[statsMin].bonus + " k/s ";
	  if (madnessMinions[statsMin].mightPerSecond > 0)
	    updatedStatsString += madnessMinions[statsMin].mightPerSecond * madnessMinions[statsMin].bonus + " f/s";
	  document.getElementById(unlockableMadnessDivs[key].statsdiv).innerHTML = updatedStatsString;
	}
	
	function calculateMadnessPerSecond() {
	
	  currMadnessPerSecond = 0; // set it to 0
	  
	  for (var key in madnessMinions) { // increase it for each minion type
	    currMadnessPerSecond += madnessPerSecondBonus * madnessMinions[key].current * madnessMinions[key].madnessPerSecond * madnessMinions[key].bonus; 
		// increase by minions times per minion times bonus
	  }
	}
	
	function updateMadness() {
	  currMadness += currMadnessPerSecond;
	}
	
	function calculateMoneyPerSecond() {
	
	  currMoneyPerSecond = 0; // set it to 0
	  
	  for (var key in madnessMinions) { // increase it for each minion type
	    currMoneyPerSecond += moneyPerSecondBonus * madnessMinions[key].current * madnessMinions[key].moneyPerSecond * madnessMinions[key].bonus; 
		// increase by minions times per minion times bonus
	  }
	}
	
	function updateMoney() {
	  currMoney += currMoneyPerSecond;
	}
	
	function setDayNightCycle(timeOfDay) {
	  if (timeOfDay > 16 && timeOfDay < 46) // day
		document.getElementById('thewholebody').style.background = "SkyBlue";
	  else if (timeOfDay < 13 || timeOfDay > 49) // night
	    document.getElementById('thewholebody').style.background = "Black";
	  else if (timeOfDay == 13 || timeOfDay == 49) // astronomical twilight
	    document.getElementById('thewholebody').style.background = "MidnightBlue";
	  else if (timeOfDay == 14 || timeOfDay == 48) // nautical twilight
	    document.getElementById('thewholebody').style.background = "DodgerBlue";
	  else if (timeOfDay == 15 || timeOfDay == 47) // civil twilight
	    document.getElementById('thewholebody').style.background = "DeepSkyBlue";
	  else if (timeOfDay == 16) // sunrise
	    document.getElementById('thewholebody').style.background = "Gold";
	  else if (timeOfDay == 46) // sunset
	    document.getElementById('thewholebody').style.background = "OrangeRed";
	}
	
	function dailyInterest() {
	  var interestMoney = currMoney * moneyDailyInterest;
	  currMoney += interestMoney;
	}
	
	//FIXME: I don't want these to be tabs anymore
	function checkUnlockMadnessTabs() {
	  for (var key in hiddenMadnessTabs) {
	    if (hiddenMadnessTabs[key].unlock()) {
		  visibleMadnessTabs[key] = madnessTab(hiddenMadnessTabs[key]);
		  delete hiddenMadnessTabs[key];
		  document.getElementById(key).hidden = false;
		  if (tabsUnlocked == 0 && key != "madnessMadnessTab")
		  {
		    visibleMadnessTabs["madnessMadnessTab"] = madnessTab(hiddenMadnessTabs["madnessMadnessTab"]);
		    delete hiddenMadnessTabs["madnessMadnessTab"];
		    document.getElementById("madnessMadnessTab").hidden = false;
			changeMadnessTab(key);
		  }
		  tabsUnlocked++;
		}
	  }
	}
	
	function checkUnlockMadnessSubTabs() {
	  for (var key in hiddenMadnessSubTabs) {
	    if (hiddenMadnessSubTabs[key].unlock()) {
		  visibleMadnessSubTabs[key] = madnessSubTab(hiddenMadnessSubTabs[key]);
		  delete hiddenMadnessSubTabs[key];
		  document.getElementById(key).hidden = false;
		  if (subTabsUnlocked == 0)
			changeMadnessSubTab(key);
		  subTabsUnlocked++;
		}
	  }
	}
	
	function checkUnlockableMadnessDivs() {
	  for (var key in unlockableMadnessDivs) {
	    if (unlockableMadnessDivs[key].unlock()) {
		  visibleMadnessDivs[key] = madnessDiv(unlockableMadnessDivs[key]);
		  delete unlockableMadnessDivs[key];
		  document.getElementById(key).hidden = false;
		  calculateAndDisplayCost(key);
		  displayAndLogMessage("You unlocked " + visibleMadnessDivs[key].title, visibleMadnessDivs[key].text);
		  if (typeof(visibleMadnessTabs[visibleMadnessDivs[key].tab]) == "object") {
		    if (!visibleMadnessTabs[visibleMadnessDivs[key].tab].active)
		      visibleMadnessTabs[visibleMadnessDivs[key].tab].notifications++;
		  }
		  else {
		    if (!hiddenMadnessTabs[visibleMadnessDivs[key].tab].active)
		      hiddenMadnessTabs[visibleMadnessDivs[key].tab].notifications++;
		  }
		  if (typeof(visibleMadnessSubTabs[visibleMadnessDivs[key].subtab]) == "object") {
		    if (!visibleMadnessSubTabs[visibleMadnessDivs[key].subtab].active)
		      visibleMadnessSubTabs[visibleMadnessDivs[key].subtab].notifications++;
		  }
		  else {
		    if (!hiddenMadnessSubTabs[visibleMadnessDivs[key].subtab].active)
		      hiddenMadnessSubTabs[visibleMadnessDivs[key].subtab].notifications++;
		  }
		}
	  }
	}

	function checkMadnessDisabledDivs() {
	  for (var key in visibleMadnessDivs) {
	  
	    var enabled = true; // start at true make false if it fails any check
		
		for (var i=0; i<visibleMadnessDivs[key].costs.length; i++) {
		  if (visibleMadnessDivs[key].costs[i].type == "madness") {
		    if (currMadness < visibleMadnessDivs[key].costs[i].current)
			  enabled = false;
		  }
		  else if (visibleMadnessDivs[key].costs[i].type == "money") {
		    if (currMoney < visibleMadnessDivs[key].costs[i].current)
			  enabled = false;
		  }
		  else if (visibleMadnessDivs[key].costs[i].type == "know") {
		    if (currKnow < visibleMadnessDivs[key].costs[i].current)
			  enabled = false;
		  }
		  else if (visibleMadnessDivs[key].costs[i].type == "might") {
		    if (currMight < visibleMadnessDivs[key].costs[i].current)
			  enabled = false;
		  }
		}
		
		for (var j=0; j<visibleMadnessDivs[key].minionCosts.length; j++) {
		  var madnessMinType = visibleMadnessDivs[key].minionCosts[j].type;
		  if (madnessMinions[madnessMinType].current < visibleMadnessDivs[key].minionCosts[j].current)
		    enabled = false;
		}

	    if (enabled) { // then it should be enabled
		  document.getElementById(key).style.backgroundColor = "white";
		  document.getElementById(key).style.borderColor = "white";
		}
		else { // it should be disabled
		  document.getElementById(key).style.backgroundColor = "gray";
		  document.getElementById(key).style.borderColor = "gray";
		}
	  }
	}
	
	// FIXME: not tabs anymore
	function madnessTabNotificationsDisplay() {
	  for (var key in visibleMadnessTabs) {
	    if (visibleMadnessTabs[key].notifications > 0 && !visibleMadnessTabs[key].active && !visibleMadnessTabs[key].showingnotify) {
		  document.getElementById(visibleMadnessTabs[key].notifyid).style.zIndex = 100;
		  visibleMadnessTabs[key].showingnotify = true;
		}
	  }
	}
	
	// FIXME: not tabs anymore
	function madnessSubTabNotificationsDisplay() {
	  for (var key in visibleMadnessSubTabs) {
	    if (visibleMadnessSubTabs[key].notifications > 0 && !visibleMadnessSubTabs[key].active && !visibleMadnessSubTabs[key].showingnotify) {
		  document.getElementById(visibleMadnessSubTabs[key].notifyid).style.zIndex = 100;
		  visibleMadnessSubTabs[key].showingnotify = true;
		}
	  }
	}
	
	// FIXME: the first display would only be for stats screen
	function madnessMinionDisplay() {
	  for (var key in madnessMinions) {
	    document.getElementById(key).innerHTML = madnessMinions[key].text + ": " + madnessMinions[key].current;
		document.getElementById(madnessMinions[key].idindiv).innerHTML = madnessMinions[key].current;
	  }
	}
	
	function madnessResourceDisplay() {
	  // FIXME: add in other two tabs
	  if (currTab == "madnessMadnessTab") {
	    document.getElementById("madness").innerHTML = "Madness: " + commafy(Math.floor(currMadness)) + "&nbsp;";
	    document.getElementById("madnessPerSecond").innerHTML = "Madness Per Second: " + commafy(currMadnessPerSecond.toFixed(1)) + "&nbsp;";
	  }
	  else if (currTab == "madnessMoneyTab") {
	    document.getElementById("money").innerHTML = "Money: " + commafy(Math.floor(currMoney)) + "&nbsp;";
	    document.getElementById("moneyPerSecond").innerHTML = "Money Per Second: " + commafy(currMoneyPerSecond.toFixed(1)) + "&nbsp;";
	  }
	}
	
	function madnessStatusDisplay() {
	  if (currTab == "madnessMadnessTab") {
	    // FIXME: reconsider this but manually updating for now
	    //document.getElementById("madnessStatusDiv").innerHTML = "The world is only slightly mad.";
	  }
	  else if (currTab == "madnessMoneyTab") {
	    var moneyBankTitle;
	    if (moneyBankAccountKey == "none")
		  moneyBankTitle = "No account";
		else
		  moneyBankTitle = visibleMadnessDivs[moneyBankAccountKey].title;
		var minString = (60 - minuteCounter).toString();
		var secString = (60 - secondCounter).toString();
		if (secString.length == 1)
		  secString = "0" + secString;
	    var moneyStatusString = moneyBankTitle + " earning " + moneyDailyInterest*100 + "% interest in " + 
		minString + ":" + secString;
	    document.getElementById("moneyStatusDiv").innerHTML = moneyStatusString;
	  }
	}
	
	function clearDisplay() {
	  context.clearRect(0,0,500,400);
	}
	
	function madnessClickImageDisplay() {
	  if (showClickImage) {
	    context.drawImage(clickImage, 100, 100);
	  }
	}
	
	function clickPopUpDisplay() {
	  for (var i=0; i<popUpNumbers.length; i++) {
	    if (popUpNumbers[i].timer < 1) {
		  popUpNumbers.splice(i,1);
		  i--;
		}
		else {
		  var alpha = popUpNumbers[i].timer / 60;
		  context.font = '16px Arial bold';
          context.fillStyle = "rgba(255, 0, 0, " + alpha + ")";
		  context.textAlign = 'center';
          context.fillText("+" + commafy(popUpNumbers[i].amount) + " " + popUpNumbers[i].type, popUpNumbers[i].xpos, (popUpNumbers[i].ypos - 140 + popUpNumbers[i].timer));
		  popUpNumbers[i].timer--;
		}
	  }	
	}
	
	function updateMadWorldDiv(aString) {
	  document.getElementById('madnessStatusDiv').innerHTML = aString;
	}
	
	function saveGame() {
	  displayTopBarMessage("Game Saved");
	  
	  savedStats[0] = currMadness;
	  savedStats[1] = currMoney;
	  savedStats[2] = currKnow;
	  savedStats[3] = currMight;
		  
	  savedStats[4] = madnessPerClick;
	  savedStats[5] = madnessPerClickBonus;
	  savedStats[6] = madnessPerBuildingClickMult;
	  savedStats[7] = moneyPerClick;
	  savedStats[8] = moneyPerClickBonus;
	  savedStats[9] = moneyPerBuildingClickMult;
	  savedStats[10] = knowPerClick;
	  savedStats[11] = knowPerClickBonus;
	  savedStats[12] = knowPerBuildingClickMult;
	  savedStats[13] = mightPerClick;
	  savedStats[14] = mightPerClickBonus;
	  savedStats[15] = mightPerBuildingClickMult;
	
	  savedStats[16] = moneyDailyInterest;
	  savedStats[17] = moneyBankAccountKey;

	  savedStats[18] = totalClicks;
	  savedStats[19] = totalMadnessClicks;
	  savedStats[20] = totalMadnessFromClicking;
	  savedStats[21] = madnessSpent;
	  savedStats[22] = totalMoneyClicks;
	  savedStats[23] = totalMoneyFromClicking;
	  savedStats[24] = moneySpent;
	  savedStats[25] = totalKnowClicks;
	  savedStats[26] = totalKnowFromClicking;
	  savedStats[27] = knowSpent;
	  savedStats[28] = totalMightClicks;
	  savedStats[29] = totalMightFromClicking;
	  savedStats[30] = mightSpent;
	  savedStats[31] = totalConvertClicks;
	  savedStats[32] = convertCostReduction;
	  savedStats[33] = totalMinionsConverted;
	  savedStats[34] = totalMoneyBuildingsConverted;
	  savedStats[35] = totalUpgrades;

	  savedStats[36] = madnessPerSecondBonus;
	  savedStats[37] = moneyPerSecondBonus;
	  savedStats[38] = knowPerSecondBonus;
	  savedStats[39] = mightPerSecondBonus;

	  savedStats[40] = tabsUnlocked;
	  savedStats[41] = subTabsUnlocked;
	  
	  savedStats[42] = document.getElementById('madnessStatusDiv').innerHTML;
	  
	  localStorage["CthulhuClickerStats"] = JSON.stringify(savedStats);
	  localStorage["CthulhuClickerMinions"] = JSON.stringify(madnessMinions);
	  
	  for (var key in visibleMadnessDivs) {
	    allMadnessDivSaveData[key] = 	  
	    (madnessDivSaveData({
          key: key,
		  costMultiplier: visibleMadnessDivs[key].costMultiplier,
		  costCount: visibleMadnessDivs[key].costCount,
		  timesClicked: visibleMadnessDivs[key].timesClicked,
		  type: visibleMadnessDivs[key].type,
        }));
	  }	  
	  localStorage["CthulhuClickerVisibleMadnessDivs"] = JSON.stringify(allMadnessDivSaveData);
	  
	  for (var key in visibleMadnessTabs) {
	    allMadnessTabSaveData[key] = key;
	  }	  
	  localStorage["CthulhuClickerVisibleMadnessTabs"] = JSON.stringify(allMadnessTabSaveData);
	  
	  for (var key in visibleMadnessSubTabs) {
	    allMadnessSubTabSaveData[key] = key;
	  }	  
	  localStorage["CthulhuClickerVisibleMadnessSubTabs"] = JSON.stringify(allMadnessSubTabSaveData);
	  
	  localStorage["CthulhuClickerMessageLogMessages"] = JSON.stringify(messageLogMessages);
		
	}
	
	function resetGame() {
	  GameOn = false;
	  delete localStorage["CthulhuClickerStats"];
	  delete localStorage["CthulhuClickerMinions"];
	  delete localStorage["CthulhuClickerVisibleMadnessDivs"];
	  delete localStorage["CthulhuClickerVisibleMadnessTabs"];
	  delete localStorage["CthulhuClickerVisibleMadnessSubTabs"];
	  delete localStorage["CthulhuClickerMessageLogMessages"];
	  
	  currMadness = 0;
	  currMoney = 0;
	  currKnow = 0;
	  currMight = 0;
		  
	  madnessPerClick = 1;
	  madnessPerClickBonus = 1;
	  madnessPerBuildingClickMult = 0;
	  moneyPerClick = 1;
	  moneyPerClickBonus = 1;
	  moneyPerBuildingClickMult = 0;
	  knowPerClick = 1;
	  knowPerClickBonus = 1;
	  knowPerBuildingClickMult = 0;
	  mightPerClick = 1;
	  mightPerClickBonus = 1;
	  mightPerBuildingClickMult = 0;
	
	  moneyDailyInterest = 0;
	  moneyBankAccountKey = "none";

	  totalClicks = 0;
	  totalMadnessClicks = 0;
	  totalMadnessFromClicking = 0;
	  madnessSpent = 0;
	  totalMoneyClicks = 0;
	  totalMoneyFromClicking = 0;
	  moneySpent = 0;
	  totalKnowClicks = 0;
	  totalKnowFromClicking = 0;
	  knowSpent = 0;
	  totalMightClicks = 0;
	  totalMightFromClicking = 0;
	  mightSpent = 0;
	  totalConvertClicks = 0;
	  convertCostReduction = 0;
	  totalMinionsConverted = 0;
	  totalMoneyBuildingsConverted = 0;
	  totalUpgrades = 0;

	  madnessPerSecondBonus = 1;
	  moneyPerSecondBonus = 1;
	  knowPerSecondBonus = 1;
	  mightPerSecondBonus = 1;

	  tabsUnlocked = 0;
	  subTabsUnlocked = 0;
	  
	  madnessMinions = {};
	  triggeredMadnessDivs = {};
	  unlockableMadnessDivs = {};
	  visibleMadnessDivs = {};
	  boughtMadnessDivs = {};
	
	  visibleMadnessClickButtons = [];
	  disabledMadnessClickButtons = [];
	
	  hiddenMadnessTabs = [];
	  visibleMadnessTabs = [];
	
	  hiddenMadnessSubTabs = [];
	  visibleMadnessSubTabs = [];
	
	  popUpNumbers = [];
	  showClickImage = false;
	  
	  document.getElementById('madnessStatusDiv').innerHTML = "The elder gods are stirring";
	
	  currTab = "madnessMadnessTab";
	  currSubTab = "madnessMadnessBuildingsSubTab";
	
	  menuExpanded = false;
	  infoExpanded = false;
	  
	  location.reload();
	}
	
	function Game(){  // every frame this happens
	  if (GameOn) {
	    frameCounter++;
		calculateMadnessPerSecond();
		calculateMoneyPerSecond();
		if (frameCounter > 60) { // do once per second stuff
		  frameCounter = 1;
		  secondCounter++;
		  updateMadness();
		  updateMoney();
		  if (topBarDisplayMessageCounter > 0)
		    topBarDisplayMessageCounter--;
		  else
		    clearTopBarMessage();
		  //setDayNightCycle(secondCounter); // day cycles once per second with this on
		}
		if (secondCounter > 60) { // do once per minute stuff
		  secondCounter = 1;
		  minuteCounter++;
		  saveGame();
		  // FIXME: don't add day night back in until it looks good and is meaningful
		  //setDayNightCycle(minuteCounter);
		  //dailyInterest(); // interest every minute here
		}
		if (minuteCounter > 60) { // do once per hour stuff
		  minuteCounter = 1;
		  dailyInterest();
		  // FIXME: new day stuff here
		}
		checkUnlockMadnessTabs();
		checkUnlockMadnessSubTabs();
		checkUnlockableMadnessDivs();
		checkMadnessDisabledDivs();
		madnessTabNotificationsDisplay();
		madnessSubTabNotificationsDisplay();
		madnessMinionDisplay();
		madnessResourceDisplay();
		madnessStatusDisplay();
		clearDisplay();
		madnessClickImageDisplay();
		clickPopUpDisplay();
		
        loop = setTimeout(Game, 1000 / 60); // 60 FPS
	  }
    }  
	
	  // --------------------- API ----------------------------
	  
	function commafy( num ) {
	// taken from http://stackoverflow.com/questions/6784894/add-commas-or-spaces-to-group-every-three-digits
      var str = num.toString().split('.');
      if (str[0].length >= 4) {
        str[0] = str[0].replace(/(\d)(?=(\d{3})+$)/g, '$1,');
      }
      if (str[1] && str[1].length >= 5) {
        str[1] = str[1].replace(/(\d{3})/g, '$1,');
      }
      return str.join('.');
	}
	  
	function calculateAndDisplayCost(key) {
	  var costDisplayString = "";
	  
	  for (var costKey in visibleMadnessDivs[key].costs) {
	    var currMult = visibleMadnessDivs[key].costMultiplier - convertCostReduction;
		if (currMult < 1.05)
		  currMult = 1.05;
		visibleMadnessDivs[key].costs[costKey].current = Math.floor(visibleMadnessDivs[key].costs[costKey].base
			* Math.pow(currMult, visibleMadnessDivs[key].costCount));
	    if (visibleMadnessDivs[key].costs[costKey].type == "madness") {
		  costDisplayString = costDisplayString + commafy(visibleMadnessDivs[key].costs[costKey].current) + "&nbsp;<img src='images/madnesschar.png' align='top'></img>&nbsp;";
		}
		else if (visibleMadnessDivs[key].costs[costKey].type == "money") {
		  costDisplayString = costDisplayString + commafy(visibleMadnessDivs[key].costs[costKey].current) + "&nbsp;<span style='color:green'>$</span>&nbsp;";
		}
		else if (visibleMadnessDivs[key].costs[costKey].type == "know") {
		  costDisplayString = costDisplayString + commafy(visibleMadnessDivs[key].costs[costKey].current) + " Knowledge ";
		}
		else if (visibleMadnessDivs[key].costs[costKey].type == "might") {
		  costDisplayString = costDisplayString + commafy(visibleMadnessDivs[key].costs[costKey].current) + " Might ";
		}
	  }
	  
	  for (var minCostKey in visibleMadnessDivs[key].minionCosts) {
	    var currMult = visibleMadnessDivs[key].costMultiplier - convertCostReduction;
		if (currMult < 1.05)
		  currMult = 1.05;
		visibleMadnessDivs[key].minionCosts[minCostKey].current = Math.floor(visibleMadnessDivs[key].minionCosts[minCostKey].base
			* Math.pow(currMult, visibleMadnessDivs[key].costCount));
	    costDisplayString = costDisplayString + "& " + commafy(visibleMadnessDivs[key].minionCosts[minCostKey].current) + " " + 
			madnessMinions[visibleMadnessDivs[key].minionCosts[minCostKey].type].text + " ";
	  }
	  
	  if (costDisplayString != "")
	    document.getElementById(visibleMadnessDivs[key].costid).innerHTML = costDisplayString.slice(0, costDisplayString.length-1);
	}
	
	function upgradeDoubleBonus(key) {
	  var upgradeDiv = visibleMadnessDivs[key];
	  if (upgradeDiv.costs[0].type == "madness")
	    currMadness -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "money")
	    currMoney -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "know")
	    currKnow -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "might")
	    currMight -= upgradeDiv.costs[0].current;
	  upgradeDiv.timesClicked++;
	  upgradeDiv.costCount++;
	  totalUpgrades++;
	  madnessMinions[upgradeDiv.minion].bonus *= 2;
			
	  visibleMadnessDivs[upgradeDiv.id].type = "boughtupgrade";
	  document.getElementById(upgradeDiv.id).hidden = true;		
	  document.getElementById(upgradeDiv.boughtdivid).hidden = false;
	  
	  displayUpdatedStats(key);
	}
	
	function upgradeIncreaseBase(key, madness, money, know, might) {
	  var upgradeDiv = visibleMadnessDivs[key];
	  if (upgradeDiv.costs[0].type == "madness")
	    currMadness -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "money")
	    currMoney -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "know")
	    currKnow -= upgradeDiv.costs[0].current;
	  else if (upgradeDiv.costs[0].type == "might")
	    currMight -= upgradeDiv.costs[0].current;
	  upgradeDiv.timesClicked++;
	  upgradeDiv.costCount++;
	  totalUpgrades++;
	  madnessMinions[upgradeDiv.minion].madnessPerSecond += madness;
	  madnessMinions[upgradeDiv.minion].moneyPerSecond += money;
	  madnessMinions[upgradeDiv.minion].knowPerSecond += know;
	  madnessMinions[upgradeDiv.minion].mightPerSecond += might;
			
	  visibleMadnessDivs[upgradeDiv.id].type = "boughtupgrade";
	  document.getElementById(upgradeDiv.id).hidden = true;		
	  document.getElementById(upgradeDiv.boughtdivid).hidden = false;
	  
	  displayUpdatedStats(key);
	}
	
	function unlockSubTabs(unlockTab, unlockType) {
	  var doUnlock = false;
	  for (var key in visibleMadnessDivs) {
	    if (visibleMadnessDivs[key].tab == unlockTab) {
		  if (visibleMadnessDivs[key].type == unlockType)
		    doUnlock = true;
		}
	  }
	  return doUnlock;
	}
	
	function Init() {
	  // --------------------- SETUP ------------------------------
	  
	  canvas.addEventListener("mousedown", doMouseDown, false);
	  document.addEventListener("mouseup", doMouseUp, false);
	
	  // --------------------- MONEY BUILDINGS ----------------------------
	  
	  madnessMinions['moneyBuildingsEight'] = 
	    (madnessMinion({
          id: 'moneyBuildingsEight',
		  idindiv: 'moneyBuildingsEightBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 10,
		  moneyPerSecond: 5000,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Pharmaceutical Company'
        }));
	  
	  madnessMinions['moneyBuildingsSeven'] = 
	    (madnessMinion({
          id: 'moneyBuildingsSeven',
		  idindiv: 'moneyBuildingsSevenBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 2,
		  moneyPerSecond: 1000,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Talk Radio Station'
        }));
	  
	  madnessMinions['moneyBuildingsSix'] = 
	    (madnessMinion({
          id: 'moneyBuildingsSix',
		  idindiv: 'moneyBuildingsSixBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: .5,
		  moneyPerSecond: 200,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Asylum'
        }));
	  
	  madnessMinions['moneyBuildingsFive'] = 
	    (madnessMinion({
          id: 'moneyBuildingsFive',
		  idindiv: 'moneyBuildingsFiveBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: .1,
		  moneyPerSecond: 50,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Half Way House'
        }));
	  
	  madnessMinions['moneyBuildingsFour'] = 
	    (madnessMinion({
          id: 'moneyBuildingsFour',
		  idindiv: 'moneyBuildingsFourBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0,
		  moneyPerSecond: 10,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Rock Candy Store'
        }));
	  
	  madnessMinions['moneyBuildingsThree'] = 
	    (madnessMinion({
          id: 'moneyBuildingsThree',
		  idindiv: 'moneyBuildingsThreeBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0,
		  moneyPerSecond: 2,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Candy Store'
        }));
	  
	  madnessMinions['moneyBuildingsTwo'] = 
	    (madnessMinion({
          id: 'moneyBuildingsTwo',
		  idindiv: 'moneyBuildingsTwoBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0,
		  moneyPerSecond: .5,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Cookie Store'
        }));
	  
	  madnessMinions['moneyBuildingsOne'] = 
	    (madnessMinion({
          id: 'moneyBuildingsOne',
		  idindiv: 'moneyBuildingsOneBuyTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0,
		  moneyPerSecond: .1,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Lemonade Stand'
        }));
	
	  // --------------------- MADNESS MINIONS ----------------------------
	  
	  madnessMinions['madnessMinionsEight'] = 
	    (madnessMinion({
          id: 'madnessMinionsEight',
		  idindiv: 'madnessMinionsEightConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 5000,
		  moneyPerSecond: 10,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Greedy CEO'
        }));
	  
	  madnessMinions['madnessMinionsSeven'] = 
	    (madnessMinion({
          id: 'madnessMinionsSeven',
		  idindiv: 'madnessMinionsSevenConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 1000,
		  moneyPerSecond: 2,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Pirate Captain'
        }));
	  
	  madnessMinions['madnessMinionsSix'] = 
	    (madnessMinion({
          id: 'madnessMinionsSix',
		  idindiv: 'madnessMinionsSixConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 200,
		  moneyPerSecond: 0.5,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Carcosan Architect'
        }));
	  
	  madnessMinions['madnessMinionsFive'] = 
	    (madnessMinion({
          id: 'madnessMinionsFive',
		  idindiv: 'madnessMinionsFiveConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 50,
		  moneyPerSecond: 0.1,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Avant-Garde Artist'
        }));
	  
	  madnessMinions['madnessMinionsFour'] = 
	    (madnessMinion({
          id: 'madnessMinionsFour',
		  idindiv: 'madnessMinionsFourConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 10,
		  moneyPerSecond: 0,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Conspiracy Theorist'
        }));
	  
	  madnessMinions['madnessMinionsThree'] = 
	    (madnessMinion({
          id: 'madnessMinionsThree',
		  idindiv: 'madnessMinionsThreeConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 2,
		  moneyPerSecond: 0,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'CDC Investigator'
        }));
	  
	  madnessMinions['madnessMinionsTwo'] = 
	    (madnessMinion({
          id: 'madnessMinionsTwo',
		  idindiv: 'madnessMinionsTwoConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0.5,
		  moneyPerSecond: 0,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Suspicious Sailor'
        }));
	  
	  madnessMinions['madnessMinionsOne'] = 
	    (madnessMinion({
          id: 'madnessMinionsOne',
		  idindiv: 'madnessMinionsOneConvertTotal',
          current: 0,
		  allTime: 0,
		  madnessPerSecond: 0.1,
		  moneyPerSecond: 0,
		  knowPerSecond: 0,
		  mightPerSecond: 0,
		  bonus: 1,
		  text: 'Crazy Homeless Person'
        }));
		
		
	  // --------------------- TABS ----------------------------
		
		hiddenMadnessTabs['madnessMadnessTab'] = 
	    (madnessTab({
          id: madnessMadnessTab,
		  title: "Madness",
		  contains: madnessSpread,
		  display: madnessDisplay,
		  buildingssubtab: "madnessMadnessBuildingsSubTab",
		  active: true,
		  notifications: 0,
		  image: "tempmadness.png",
		  notifyid: "madnessnotify",
		  notifyimage: "tempmadnessnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks at 5 madness, same as the first madness button
		    if (currMadness >= 5)
			  return true;
			else
			  return false;
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMadnessBuildingsSubTab'] = 
	    (madnessSubTab({
          id: madnessMadnessBuildingsSubTab,
		  contains: madnessSpreadConvert,
		  active: false,
		  notifications: 0,
		  image: "tempminions.png",
		  notifyid: "madnessbuildingsnotify",
		  notifyimage: "tempminionsnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks at 10 madness, same as the first madness button
		    if (currMadness >= 5)
			  return true;
			else
			  return false;
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMadnessUpgradesSubTab'] = 
	    (madnessSubTab({
          id: madnessMadnessUpgradesSubTab,
		  contains: madnessSpreadUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempupgrade.png",
		  notifyid: "madnessupgradesnotify",
		  notifyimage: "tempupgradenotify.png",
		  showingnotify: false,
		  unlock: function () {
		    return unlockSubTabs("madnessMadnessTab", "upgrade");
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMadnessBoughtUpgradesSubTab'] = 
	    (madnessSubTab({
          id: madnessMadnessBoughtUpgradesSubTab,
		  contains: madnessSpreadBoughtUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempbought.png",
		  notifyid: "madnessboughtupgradesnotify",
		  notifyimage: "tempboughtnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    return unlockSubTabs("madnessMadnessTab", "boughtupgrade");
		  }
        }));
		
		hiddenMadnessTabs['madnessMoneyTab'] = 
	    (madnessTab({
          id: madnessMoneyTab,
		  title: "Money",
		  contains: madnessInvest,
		  display: moneyDisplay,
		  buildingssubtab: "madnessMoneyBuildingsSubTab",
		  active: false,
		  notifications: 0,
		  image: "tempmoney.png",
		  notifyid: "moneynotify",
		  notifyimage: "tempmoneynotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks as soon as you get money
			if (currMoney > 0)
			  return true;
			else
			  return false;
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMoneyBuildingsSubTab'] = 
	    (madnessSubTab({
          id: madnessMoneyBuildingsSubTab,
		  contains: madnessInvestBuildings,
		  active: false,
		  notifications: 0,
		  image: "tempbuildings.png",
		  notifyid: "moneybuildingsnotify",
		  notifyimage: "tempminionsnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks at 5 money, same as the first money button
		    if (currMoney >= 5)
			  return true;
			else
			  return false;
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMoneyUpgradesSubTab'] = 
	    (madnessSubTab({
          id: madnessMoneyUpgradesSubTab,
		  contains: madnessInvestUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempupgrade.png",
		  notifyid: "moneyupgradesnotify",
		  notifyimage: "tempupgradenotify.png",
		  showingnotify: false,
		  unlock: function () {
		    return unlockSubTabs("madnessMoneyTab", "upgrade");
		  }
        }));
		
		hiddenMadnessSubTabs['madnessMoneyBoughtUpgradesSubTab'] = 
	    (madnessSubTab({
          id: madnessMoneyBoughtUpgradesSubTab,
		  contains: madnessInvestBoughtUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempbought.png",
		  notifyid: "moneyboughtupgradesnotify",
		  notifyimage: "tempboughtnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    return unlockSubTabs("madnessMoneyTab", "boughtupgrade");
		  }
        }));
		
		// FIXME: need to fix this here
		hiddenMadnessTabs['madnessKnowTab'] = 
	    (madnessTab({
          id: madnessKnowTab,
		  title: "Knowledge",
		  contains: madnessResearch,
		  display: knowDisplay,
		  upgradesdiv: madnessKnowUpgrades,
		  buildingsdiv: madnessKnowBuildings,
		  boughtupgradesdiv: madnessKnowBoughtUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempknow.png",
		  notifyimage: "tempknownotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks as soon as you get knowledge
			if (currKnow > 0)
			  return true;
			else
			  return false;
		  }
        }));
		
		hiddenMadnessTabs['madnessMightTab'] = 
	    (madnessTab({
          id: madnessMightTab,
		  title: "Might",
		  contains: madnessFight,
		  display: mightDisplay,
		  upgradesdiv: madnessMightUpgrades,
		  buildingsdiv: madnessMightBuildings,
		  boughtupgradesdiv: madnessMightBoughtUpgrades,
		  active: false,
		  notifications: 0,
		  image: "tempmight.png",
		  notifyimage: "tempmightnotify.png",
		  showingnotify: false,
		  unlock: function () {
		    // this unlocks as soon as you get might
			if (currMight > 0)
			  return true;
			else
			  return false;
		  }
        }));
		
		// FIXME: clarify the active tab and make it clearer its a tab when its new by theming
		
	  // --------------------- CLICK BUTTONS ----------------------------
	  
	  visibleMadnessClickButtons['madnessClickButton'] = 
	    (madnessClickButton({
          id: madnessClickButton,
		  tab: "madnessClickTab",
		  type: "click",
          click: function (mouseX, mouseY) {
			  totalClicks++;
			  totalMadnessClicks++;
			  var moreMadness = (madnessPerClick * madnessPerClickBonus) * (1 + madnessPerBuildingClickMult * totalMinionsConverted);
			  currMadness += moreMadness;
			  totalMadnessFromClicking += moreMadness;
			  
			  popUpNumbers.push(popUpNumber({
		        amount: Math.floor(moreMadness),
                type: "Madness",
		        xpos: mouseX - 8,
		        ypos: mouseY - 8,
		        timer: 60
              }));
		  },
		  costs: [],
		  minionCosts: [],
        }));
		
		visibleMadnessClickButtons['moneyClickButton'] = 
	    (madnessClickButton({
          id: moneyClickButton,
		  tab: "moneyClickTab",
		  type: "click",
          click: function (mouseX, mouseY) {
			  totalClicks++;
			  totalMoneyClicks++;
			  var moreMoney = (moneyPerClick * moneyPerClickBonus) * (1 + moneyPerBuildingClickMult * totalMoneyBuildingsConverted);
			  currMoney += moreMoney;
			  totalMoneyFromClicking += moreMoney;
			  
			  popUpNumbers.push(popUpNumber({
		        amount: Math.floor(moreMoney),
                type: "Money",
		        xpos: mouseX - 8,
		        ypos: mouseY - 8,
		        timer: 60
              }));
		  },
		  costs: [],
		  minionCosts: [],
        }));
		
		visibleMadnessClickButtons['knowClickButton'] = 
	    (madnessClickButton({
          id: knowClickButton,
		  tab: "knowClickTab",
		  type: "click",
          click: function (mouseX, mouseY) {
			  totalClicks++;
			  totalKnowClicks++;
			  var moreKnow = (knowPerClick * knowPerClickBonus) * (1 + knowPerBuildingClickMult * totalKnowBuildingsConverted);
			  currKnow += moreKnow;
			  totalKnowFromClicking += moreKnow;
			  
			  popUpNumbers.push(popUpNumber({
		        amount: Math.floor(moreKnow),
                type: "Knowledge",
		        xpos: mouseX - 8,
		        ypos: mouseY - 8,
		        timer: 60
              }));
		  },
		  costs: [],
		  minionCosts: [],
        }));
		
		visibleMadnessClickButtons['mightClickButton'] = 
	    (madnessClickButton({
          id: mightClickButton,
		  tab: "mightClickTab",
		  type: "click",
          click: function (mouseX, mouseY) {
			  totalClicks++;
			  totalMightClicks++;
			  var moreMight = (mightPerClick * mightPerClickBonus) * (1 + mightPerBuildingClickMult * totalMightBuildingsConverted);
			  currMight += moreMight;
			  totalMightFromClicking += moreMight;
			  
			  popUpNumbers.push(popUpNumber({
		        amount: Math.floor(moreMight),
                type: "Might",
		        xpos: mouseX - 8,
		        ypos: mouseY - 8,
		        timer: 60
              }));
		  },
		  costs: [],
		  minionCosts: [],
        }));
		
		unlockableMadnessDivs = generateMadnessDivs();
		
		

	    
		// ------------------ POPULATE DIVS --------------------
		
		for (var key in unlockableMadnessDivs) {
		  var addDiv = document.createElement("div"); 
		  if (unlockableMadnessDivs[key].tab == "madnessMadnessTab") {
			if (unlockableMadnessDivs[key].type == "building") {
			  addDiv.innerHTML = "<div id='" + key + "' hidden=true class='convertdiv' onclick='madnessClick(&quot;" + key + "&quot;)'>" +
				"<div id='" + key + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Total' class='itemtotal'>0</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"<div id='" + key + "Cost' class='itemcost'>0</div>" +
				"</div>";
		      document.getElementById('madnessSpreadConvert').appendChild(addDiv);
		    }
			else if (unlockableMadnessDivs[key].type == "upgrade") {
			  addDiv.innerHTML = "<div id='" + key + "' hidden=true class='upgradediv' onclick='madnessClick(&quot;" + key + "&quot;)'>" +
				"<div id='" + key + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"<div id='" + key + "Cost' class='itemcost'>0</div>" +
				"</div>";
		      document.getElementById('madnessSpreadUpgrades').appendChild(addDiv);
			  
			  var addDiv2 = document.createElement("div");
			  var boughtID = unlockableMadnessDivs[key].boughtdivid;
			  addDiv2.innerHTML = "<div id='" + boughtID + "' hidden=true class='boughtupgradediv'>" +
				"<div id='" + boughtID + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"</div>";
		      document.getElementById('madnessSpreadBoughtUpgrades').appendChild(addDiv2);
			}
		  }
		  
		  else if (unlockableMadnessDivs[key].tab == "madnessMoneyTab") {
			if (unlockableMadnessDivs[key].type == "building") {
			  addDiv.innerHTML = "<div id='" + key + "' hidden=true class='convertdiv' onclick='madnessClick(&quot;" + key + "&quot;)'>" +
				"<div id='" + key + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Total' class='itemtotal'>0</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"<div id='" + key + "Cost' class='itemcost'>0</div>" +
				"</div>";
		      document.getElementById('madnessInvestBuildings').appendChild(addDiv);
		    }
			else if (unlockableMadnessDivs[key].type == "upgrade") {
			  addDiv.innerHTML = "<div id='" + key + "' hidden=true class='upgradediv' onclick='madnessClick(&quot;" + key + "&quot;)'>" +
				"<div id='" + key + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"<div id='" + key + "Cost' class='itemcost'>0</div>" +
				"</div>";
		      document.getElementById('madnessInvestUpgrades').appendChild(addDiv);
			  
			  var addDiv2 = document.createElement("div");
			  var boughtID = unlockableMadnessDivs[key].boughtdivid;
			  addDiv2.innerHTML = "<div id='" + boughtID + "' hidden=true class='boughtupgradediv'>" +
				"<div id='" + boughtID + "Title' class='itemtitle'>" + unlockableMadnessDivs[key].title + "</div>" +
				"<div id='" + key + "Stats' class='itemstats'>" + unlockableMadnessDivs[key].stats + "</div>" +
				"</div>";
		      document.getElementById('madnessInvestBoughtUpgrades').appendChild(addDiv2);
			}
		  }
		}
		
		// ------------------ LOAD SAVE --------------------
		
		if (localStorage["CthulhuClickerStats"]) { // current resources etc
	      savedStats = JSON.parse(localStorage["CthulhuClickerStats"]);
	    }
		// FIXME: this might be more than I need, like a lot more
		if (savedStats.length > 0) { // then assume it is full
		  currMadness = savedStats[0];
		  currMoney = savedStats[1];
		  currKnow = savedStats[2];
		  currMight = savedStats[3];
		  
		  madnessPerClick = savedStats[4];
		  madnessPerClickBonus = savedStats[5];
		  madnessPerBuildingClickMult = savedStats[6];
		  moneyPerClick = savedStats[7];
		  moneyPerClickBonus = savedStats[8];
		  moneyPerBuildingClickMult = savedStats[9];
		  knowPerClick = savedStats[10];
		  knowPerClickBonus = savedStats[11];
		  knowPerBuildingClickMult = savedStats[12];
		  mightPerClick = savedStats[13];
		  mightPerClickBonus = savedStats[14];
		  mightPerBuildingClickMult = savedStats[15];
	
		  moneyDailyInterest = savedStats[16];
		  moneyBankAccountKey = savedStats[17];

		  totalClicks = savedStats[18];
		  totalMadnessClicks = savedStats[19];
		  totalMadnessFromClicking = savedStats[20];
		  madnessSpent = savedStats[21];
		  totalMoneyClicks = savedStats[22];
		  totalMoneyFromClicking = savedStats[23];
		  moneySpent = savedStats[24];
		  totalKnowClicks = savedStats[25];
		  totalKnowFromClicking = savedStats[26];
		  knowSpent = savedStats[27];
		  totalMightClicks = savedStats[28];
		  totalMightFromClicking = savedStats[29];
		  mightSpent = savedStats[30];
		  totalConvertClicks = savedStats[31];
		  convertCostReduction = savedStats[32];
		  totalMinionsConverted = savedStats[33];
		  totalMoneyBuildingsConverted = savedStats[34];
		  totalUpgrades = savedStats[35];

	      madnessPerSecondBonus = savedStats[36];
		  moneyPerSecondBonus = savedStats[37];
		  knowPerSecondBonus = savedStats[38];
		  mightPerSecondBonus = savedStats[39];

		  tabsUnlocked = savedStats[40];
		  subTabsUnlocked = savedStats[41];
		  
		  document.getElementById('madnessStatusDiv').innerHTML = savedStats[42];
		}
		if (localStorage["CthulhuClickerMinions"])
	      madnessMinions = JSON.parse(localStorage["CthulhuClickerMinions"]);
		
		if (localStorage["CthulhuClickerVisibleMadnessDivs"]) {
          allMadnessDivSaveData = JSON.parse(localStorage["CthulhuClickerVisibleMadnessDivs"]);
		  for (var key in allMadnessDivSaveData) {
			visibleMadnessDivs[key] = madnessDiv(unlockableMadnessDivs[key]);
		    delete unlockableMadnessDivs[key];
			visibleMadnessDivs[key].clickMultiplier = allMadnessDivSaveData[key].clickMultiplier;
			visibleMadnessDivs[key].costCount = allMadnessDivSaveData[key].costCount;
			visibleMadnessDivs[key].timesClicked = allMadnessDivSaveData[key].timesClicked;
			visibleMadnessDivs[key].type = allMadnessDivSaveData[key].type;
			document.getElementById(key).hidden = false;
			if (allMadnessDivSaveData[key].type == "boughtupgrade") {
			  document.getElementById(visibleMadnessDivs[key].id).hidden = true;
			  document.getElementById(visibleMadnessDivs[key].boughtdivid).hidden = false;
			}
			calculateAndDisplayCost(visibleMadnessDivs[key].id);
		  }
		}
		
		if (localStorage["CthulhuClickerVisibleMadnessTabs"]) {
		  allMadnessTabSaveData = JSON.parse(localStorage["CthulhuClickerVisibleMadnessTabs"]);
		  for (var key in allMadnessTabSaveData) {
		    visibleMadnessTabs[key] = madnessTab(hiddenMadnessTabs[key]);
		    delete hiddenMadnessTabs[key];
		    document.getElementById(key).hidden = false;
		  }
		  changeMadnessTab("madnessMadnessTab");
		}
		
		if (localStorage["CthulhuClickerVisibleMadnessSubTabs"]) {
		  allMadnessSubTabSaveData = JSON.parse(localStorage["CthulhuClickerVisibleMadnessSubTabs"]);
		  for (var key in allMadnessSubTabSaveData) {
		    visibleMadnessSubTabs[key] = madnessSubTab(hiddenMadnessSubTabs[key]);
		    delete hiddenMadnessSubTabs[key];
		    document.getElementById(key).hidden = false;
		  }
		}
		
		if (localStorage["CthulhuClickerMessageLogMessages"]) {
		  messageLogMessages = JSON.parse(localStorage["CthulhuClickerMessageLogMessages"]);
		}
		
		for (var key in visibleMadnessDivs) {
		  if (typeof visibleMadnessDivs[key].stats == "undefined")
		    displayUpdatedStats(key);
		}
		
		for (var key in unlockableMadnessDivs) {
		  if (typeof unlockableMadnessDivs[key].stats == "undefined")
		    displayOriginalStats(key);
		}
		
		GameOn = true;
		
	  Game();
	}
	
	loadImages(sources, Init); 
	
	</script>

</body>
</html>